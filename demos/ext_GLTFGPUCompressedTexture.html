<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GLTFGPUCompressedTexture Demo</title>
    <style>
      * {
        padding: 0;
        margin: 0;
      }
    </style>
    <script src="https://cdn.bootcdn.net/ajax/libs/vConsole/3.3.4/vconsole.min.js"></script>
    <script>
      location.search.indexOf('?d=true') !== -1 && new VConsole();
    </script>
  </head>
  <body>
    <script type="module">
      import * as THREE from '../build/three.module.js';
      import { BrowserPlatform } from '../src/BrowserPlatform/index.js';
      import { GLTFLoader } from '../examples/jsm/loaders/GLTFLoader.js';
      import { GLTFGPUCompressedTexture } from '../extensions/GLTFGPUCompressedTexture.js';
      import { OrbitControls } from '../examples/jsm/controls/OrbitControls.js';
      // import { ZSTDDecoder } from '../examples/jsm/libs/zstddec.module.js';

      THREE.PLATFORM.set(new BrowserPlatform());

      const aspectRatio = innerWidth / innerHeight;
      const renderer = new THREE.WebGL1Renderer();
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, aspectRatio, 0.1, 100);
      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      const gltfLoader = new GLTFLoader();
      gltfLoader.register(parser => {
        return new GLTFGPUCompressedTexture(parser, renderer);
      });
      const useImageBitmapLoader =
        typeof createImageBitmap !== 'undefined' &&
        /Firefox/.test(navigator.userAgent) === false;

      console.log(
        `use ${useImageBitmapLoader ? 'ImageBitmapLoader' : 'TextureLoader'}`,
      );

      // const baseUrl = 'http://127.0.0.1:8080';
      const baseUrl = 'http://192.168.10.140:8080';
      const cases = [
        {
          uri: baseUrl + '/glb/Fendi_banzi_green.glb',
          name: 'first',
        },
        {
          uri: baseUrl + '/no-mipmap/Fendi_banzi_blue.gltf',
          name: 'gltf-tc zstd',
        },
        {
          uri: baseUrl + '/no-zstd/Fendi_banzi_blue.gltf',
          name: 'gltf-tc mipmap',
        },
        {
          uri: baseUrl + '/zstd/Fendi_banzi_blue.gltf',
          name: 'gltf-tc zstd mipmap',
        },
        {
          uri: baseUrl + '/glb/Fendi_banzi_blue.glb',
          name: 'glb',
        },
        {
          uri: baseUrl + '/gltf/Fendi_banzi_blue.gltf',
          name: 'gltf',
        },
      ];

      const load = async () => {
        for (let i = 0; i < cases.length; i++) {
          // if (i !== 5) continue
          await trackGroup(
            cases[i].name,
            async () => {
              const gltf = await track('load', () =>
                gltfLoader.loadAsync(cases[i].uri),
              );
              gltf.parser = null;
              gltf.scene.position.y = 1 - i * 0.3;
              // gltf.scene.position.x = 0.25;
              gltf.scene.scale.set(2, 2, 2);
              scene.add(gltf.scene);
              track('renderer.compile', () => {
                renderer.compile(gltf.scene, camera);
              });
              track('render', render);
              await sleep(500);
            },
            sumGroup,
          );
        }
      };

      load();

      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.setPixelRatio(devicePixelRatio);
      renderer.setSize(innerWidth, innerHeight);
      camera.position.z = 2;
      scene.background = new THREE.Color(0xffffff);
      scene.add(new THREE.AmbientLight(0xffffff, 1));
      scene.add(new THREE.DirectionalLight(0xffffff, 1));

      const render = (name = '') => {
        controls.update();
        renderer.render(scene, camera);
        // requestAnimationFrame(render);
      };

      document.body.appendChild(renderer.domElement);
      render('init');

      function sleep(t) {
        return new Promise(r => setTimeout(r, t));
      }

      var currTrackInfo = {};
      async function track(name, fn) {
        const t = performance.now();
        const res = await fn();
        const cost = performance.now() - t;
        // console.log(name, cost);
        currTrackInfo[name] = cost;
        return res;
      }
      async function trackGroup(name, fn, sumFn) {
        console.log(`===========${name}===========`);
        currTrackInfo = {};
        await fn();
        sumFn(currTrackInfo);
        console.table(currTrackInfo);
      }
      function sumGroup(trackInfo) {
        trackInfo.loadRender = trackInfo.load + trackInfo.render;
        console.log('sum', trackInfo.loadRender);
      }
    </script>
  </body>
</html>
