<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GLTFGPUCompressedTexture Demo</title>
    <style>
      * {
        padding: 0;
        margin: 0;
      }
    </style>
    <script src="https://cdn.bootcdn.net/ajax/libs/vConsole/3.3.4/vconsole.min.js"></script>
    <script>
      location.search.indexOf('?d=true') !== -1 && new VConsole();
    </script>
  </head>
  <body>
    <script type="module">
      import * as THREE from '../build/three.module.js';
      import { BrowserPlatform } from '../src/BrowserPlatform/index.js';
      import { GLTFLoader } from '../examples/jsm/loaders/GLTFLoader.js';
      import { GLTFGPUCompressedTexture } from '../extensions/GLTFGPUCompressedTexture.js';
      import { OrbitControls } from '../examples/jsm/controls/OrbitControls.js';

      THREE.PLATFORM.set(new BrowserPlatform());

      const renderer = new THREE.WebGL1Renderer();
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(
        75,
        innerWidth / innerHeight,
        0.1,
        100,
      );
      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      const gltfLoader = new GLTFLoader();
      gltfLoader.register(parser => {
        return new GLTFGPUCompressedTexture(parser, renderer);
      });
      // gltfLoader
      //   .loadAsync('./gltf/GLTFGPUCompressedTexture/no_mipmap/scene.gltf')
      //   .then(gltf => {
      //     gltf.parser = null;
      //     gltf.scene.position.x = 0.5;
      //     scene.add(gltf.scene);
      //   });

      // gltfLoader
      //   .loadAsync('./gltf/GLTFGPUCompressedTexture/with_mipmap/scene.gltf')
      //   .then(gltf => {
      //     gltf.parser = null;
      //     gltf.scene.position.x = -0.5;
      //     scene.add(gltf.scene);
      //   });

      const load = async () => {
        {
          const gltf = await gltfLoader.loadAsync(
            'http://127.0.0.1:8080/glb/Fendi_banzi_blue.glb',
          );
          gltf.parser = null;
          gltf.scene.position.y = 0.72;
          gltf.scene.position.x = -0.75;
          gltf.scene.scale.set(2, 2, 2);
          scene.add(gltf.scene);
          render('glb');
        }
        await sleep(500);
        {
          const gltf = await gltfLoader.loadAsync(
            'http://127.0.0.1:8080/gltf/Fendi_banzi_blue.gltf',
          );
          gltf.parser = null;
          gltf.scene.position.y = 0.72;
          gltf.scene.position.x = -0.25;
          gltf.scene.scale.set(2, 2, 2);
          scene.add(gltf.scene);
          render('gltf');
        }
        await sleep(500);
        {
          const gltf = await gltfLoader.loadAsync(
            'http://127.0.0.1:8080/no-zstd/Fendi_banzi_blue.gltf',
          );
          gltf.parser = null;
          gltf.scene.position.y = 0.72;
          gltf.scene.position.x = 0.25;
          gltf.scene.scale.set(2, 2, 2);
          scene.add(gltf.scene);

          render('gltf-tc no zstd');
        }
        await sleep(500);
        {
          const gltf = await gltfLoader.loadAsync(
            'http://127.0.0.1:8080/zstd/Fendi_banzi_blue.gltf',
          );
          gltf.parser = null;
          gltf.scene.position.y = 0.72;
          gltf.scene.position.x = 0.75;
          gltf.scene.scale.set(2, 2, 2);
          scene.add(gltf.scene);

          render('gltf-tc zstd');
        }
      };

      load();

      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.setPixelRatio(devicePixelRatio);
      renderer.setSize(innerWidth, innerHeight);
      camera.position.z = 2;
      scene.background = new THREE.Color(0xffffff);
      scene.add(new THREE.AmbientLight(0xffffff, 1));
      scene.add(new THREE.DirectionalLight(0xffffff, 1));

      const render = (name = '') => {
        const t1 = performance.now();
        controls.update();
        renderer.render(scene, camera);
        const cost = performance.now() - t1;
        console.log(name, 'render cost', cost);
        // requestAnimationFrame(render);
      };

      document.body.appendChild(renderer.domElement);
      render('init');

      function sleep(t) {
        console.log('======================')
        return new Promise(r => setTimeout(r, t));
      }
    </script>
  </body>
</html>
